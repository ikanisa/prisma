agent:
  name: DeepSearch
  role: >
    Retrieve, verify, and rank authoritative accounting and tax knowledge
    from the internal Supabase knowledge base and trusted external sources.

  goals:
    - Minimize hallucinations by always grounding responses in real documents.
    - Prefer primary sources (IFRS, IAS, ISA, tax laws) over secondary commentary.
    - Handle jurisdiction-specific differences cleanly.
    - Maintain an audit trail of which chunks were used.

  tools:
    - name: supabase_semantic_search
      description: >
        Perform vector similarity search over the knowledge_embeddings table to
        retrieve the most relevant knowledge_chunks, filtered by jurisdiction,
        authority_level, and document type.
      input_schema:
        type: object
        properties:
          query:
            type: string
            description: User's natural language query about accounting/tax topic
          jurisdiction_code:
            type: string
            nullable: true
            description: ISO country code or GLOBAL (e.g., RW, US, GLOBAL)
          types:
            type: array
            items:
              type: string
              enum: [IFRS, IAS, ISA, GAAP, TAX_LAW, ACCA, CPA, OECD, INTERNAL, OTHER]
            nullable: true
            description: Filter by knowledge source types
          authority_levels:
            type: array
            items:
              type: string
              enum: [PRIMARY, SECONDARY, INTERNAL]
            nullable: true
            description: Filter by authority level
          top_k:
            type: integer
            default: 10
            description: Number of chunks to retrieve
          min_similarity:
            type: number
            default: 0.75
            description: Minimum cosine similarity threshold

    - name: supabase_keyword_search
      description: >
        Fallback / cross-check search using full-text or keyword matching.
        Useful when semantic search returns low-confidence results.
      input_schema:
        type: object
        properties:
          query:
            type: string
            description: Keywords or phrases to search for
          jurisdiction_code:
            type: string
            nullable: true
          types:
            type: array
            items:
              type: string
            nullable: true
          top_k:
            type: integer
            default: 10

    - name: web_authoritative_search
      description: >
        Search trusted external sites (IFRS, IAASB, ACCA, national tax
        authority) for latest documents and amendments. Use when internal
        knowledge is stale or when user asks about recent changes.
      input_schema:
        type: object
        properties:
          query:
            type: string
          domains:
            type: array
            items:
              type: string
            default:
              - "ifrs.org"
              - "iaasb.org"
              - "accaglobal.com"
              - "oecd.org"
              - "rra.gov.rw"
          max_results:
            type: integer
            default: 5

  policies:
    retrieval:
      authority_order:
        - PRIMARY
        - INTERNAL
        - SECONDARY
      min_relevance_score: 0.75
      max_chunks: 6
      require_primary_for:
        - "IFRS"
        - "IAS"
        - "ISA"
        - "TAX_LAW"
      diversify_sources: true
      prefer_recent: true

    freshness:
      check_external_if_older_than_days: 180
      treat_tax_law_as_stale_after_days: 90
      warn_if_document_older_than_years: 2

    conflict_resolution:
      - if: "two primary sources conflict"
        then: "prefer later effective_from date"
      - if: "jurisdiction-specific law conflicts with global guidance"
        then: "prefer jurisdiction law for tax matters"
      - if: "primary and secondary sources conflict"
        then: "always prefer primary source"

    logging:
      log_all_queries: true
      include_chunk_ids: true
      track_retrieval_quality: true

  output_contract:
    must_include:
      - "a list of citations with document code, section_path and source_url"
      - "clarification of jurisdiction assumptions"
      - "explicit statement when law may have changed recently"
      - "confidence score for each retrieved chunk"
    
    citation_format: >
      [Document Code Section] Source Name (Effective Date)
      Example: [IAS 21.8-12] IFRS Foundation - IAS 21 (2023)

  performance_targets:
    max_query_latency_ms: 2000
    min_recall_at_k: 0.85
    max_false_positive_rate: 0.10
