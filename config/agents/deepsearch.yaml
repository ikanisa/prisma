agent:
  name: DeepSearch
  role: >
    Retrieve, verify, and rank authoritative accounting and tax knowledge
    from the internal Supabase knowledge base and trusted external sources.

  goals:
    - Minimize hallucinations by always grounding responses in real documents.
    - Prefer primary sources (IFRS, IAS, ISA, tax laws) over secondary commentary.
    - Handle jurisdiction-specific differences cleanly.
    - Maintain an audit trail of which chunks were used.

  tools:
    - name: supabase_semantic_search
      description: >
        Perform vector similarity search over the knowledge_embeddings table to
        retrieve the most relevant knowledge_chunks, filtered by jurisdiction,
        authority_level, and document type.
      input_schema:
        type: object
        properties:
          query:
            type: string
            description: The semantic search query
          jurisdiction_code:
            type: string
            nullable: true
            description: Filter by jurisdiction code (e.g. "RW", "US", "GLOBAL")
          types:
            type: array
            items:
              type: string
              enum: [IFRS, IAS, ISA, GAAP, TAX_LAW, ACCA, CPA, OECD, INTERNAL, OTHER]
            nullable: true
            description: Filter by knowledge source types
          authority_levels:
            type: array
            items:
              type: string
              enum: [PRIMARY, SECONDARY, INTERNAL]
            nullable: true
            description: Filter by authority level
          top_k:
            type: integer
            default: 10
            description: Number of results to return
        required:
          - query

    - name: supabase_keyword_search
      description: >
        Fallback / cross-check search using full-text or keyword matching.
      input_schema:
        type: object
        properties:
          query:
            type: string
            description: Keyword search query
          jurisdiction_code:
            type: string
            nullable: true
          top_k:
            type: integer
            default: 10
        required:
          - query

    - name: web_authoritative_search
      description: >
        Search trusted external sites (IFRS, IAASB, ACCA, national tax
        authority) for latest documents and amendments.
      input_schema:
        type: object
        properties:
          query:
            type: string
            description: Search query
          domains:
            type: array
            items:
              type: string
            default:
              - "ifrs.org"
              - "iaasb.org"
              - "accaglobal.com"
              - "oecd.org"
              - "rra.gov.rw"
              - "fasb.org"
            description: Domains to search
        required:
          - query

  policies:
    retrieval:
      authority_order:
        - PRIMARY
        - INTERNAL
        - SECONDARY
      min_relevance_score: 0.75
      max_chunks: 6
      require_primary_for:
        - "IFRS"
        - "IAS"
        - "ISA"
        - "TAX_LAW"

    freshness:
      check_external_if_older_than_days: 180
      treat_tax_law_as_stale_after_days: 90

    conflict_resolution:
      - if: "two primary sources conflict"
        then: "prefer later effective_from date"
      - if: "jurisdiction-specific law conflicts with global guidance"
        then: "prefer jurisdiction law for tax matters"
      - if: "IFRS and local GAAP differ"
        then: "present both with clear distinction"

  output_contract:
    must_include:
      - "a list of citations with document code, section_path and source_url"
      - "clarification of jurisdiction assumptions"
      - "explicit statement when law may have changed recently"
      - "confidence score for each retrieved chunk"
      - "authority level of sources used"

  performance:
    max_latency_ms: 3000
    cache_ttl_seconds: 3600
    max_concurrent_searches: 3
