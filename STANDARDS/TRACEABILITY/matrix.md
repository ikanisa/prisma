# Tax Module Traceability Matrix

The matrix aligns statutory requirements with the new database schemas, API routes, UI workspaces, and automated tests.

| Requirement | Supabase Schema | API Route | UI Workspace | Test Coverage | Notes |
| --- | --- | --- | --- | --- | --- |
| Malta CIT (ISA 315, MT CIT Act) | `mt_cit_calculations` | `/api/tax/mt/cit/compute` | Malta core – CIT | `tests/tax/test_calculators.py::test_malta_cit_decisions` | Review threshold 500k triggers Head of Tax approval. |
| Malta NID / Participation Benefit | `mt_nid_positions` | Client computation | Malta core – Participation/NID | `tests/tax/test_calculators.py::test_malta_nid_cap` | Enforces statutory cap and utilisation metric. |
| ATAD ILR (EU ATAD) | `mt_atad_ilr_evaluations` | Client computation | Malta core – ATAD ILR | `tests/tax/test_calculators.py::test_atad_ilr_refusal_gate` | Refusal when disallowed interest > 20% EBITDA. |
| Fiscal Unity (MT regulations) | `mt_fiscal_unity_reviews` | Client computation | Malta core – Fiscal unity | `tests/tax/test_calculators.py::test_fiscal_unity_review` | Review when pooling benefit claimed, refusal on loss. |
| VAT/OSS/IOSS (EU VAT directive) | `eu_vat_periods` | `/api/vat/period/prepare` | EU overlays – VAT | `tests/tax/test_vat_workflow.py::test_vat_review_flags` | Review on refunds and non-domestic schemes. |
| DAC6 (EU DAC6) | `eu_dac6_assessments` | `/api/dac6/scan` | EU overlays – DAC6 scanner | `tests/tax/test_calculators.py::test_dac6_flagging` | Refusal when >2 arrangements flagged. |
| Pillar Two (OECD GloBE) | `eu_pillar_two_monitoring` | `/api/p2/compute` | EU overlays – Pillar Two | `tests/tax/test_calculators.py::test_pillar_two_top_up` | Refusal when aggregate top-up ≥ 500k. |
| Treaty Resolver / MAP / APA | `intl_treaty_resolver_runs` | `/api/treaty/resolve` | International – Treaty resolver | `tests/tax/test_calculators.py::test_treaty_workflow` | Review when MAP unavailable or APA requested. |
| US GILTI (IRC §951A) | `us_overlay_gilti_runs` | `/api/us/gilti/compute` | International – US overlays | `tests/tax/test_calculators.py::test_us_gilti_thresholds` | Refusal when no GILTI base, review above 250k tax. |
| Autonomy Telemetry & Policy Packs | `autonomy_telemetry_events`, `autonomy_policy_packs` | Activity logging within all routes | Evidence export banner | `tests/tax/test_telemetry_payloads` | Ensures activity snapshots include decision + metrics. |


# Traceability Matrix — Accounting Close Foundation (A-1)

## Governance & Approvals Backbone
| Standard / Regulation | Clause reference | Control / Requirement | Implementation (code or schema) | Evidence captured |
| --- | --- | --- | --- | --- |
| ISQM 1 | 25-32 | Maintain documented quality objectives and monitoring across audit, tax, accounting. | Governance policy packs `STANDARDS/POLICY/audit_governance_pack.md`, `tax_governance_pack.md`, `accounting_governance_pack.md`; approvals overview `STANDARDS/POLICY/approvals_matrix.md`. | Policy acknowledgement workflow, ActivityLog `module` + `policy_pack` columns populated via catalog. |
| ISA 230 | 8-11 | Preserve audit documentation completeness with hashed manifests. | Archive sync function `/functions/v1/archive-sync`, `engagement_archives` manifest updates, ActivityLog `ARCHIVE_MANIFEST_UPDATED`. | Archive manifest returning checksum & module summary stored in `engagement_archives`. |
| ISA 220 (Revised) | 13-39 | Enforce partner/EQR leadership over audit engagements. | Approval queue kinds `AUDIT_PLAN_FREEZE`, `AUDIT_REPORT_RELEASE`; Activity event catalog entries `PLAN_*` with policy pack `AP-GOV-1`. | ActivityLog enriched columns, approval_queue records, immutable archive manifest on plan lock. |
| ISA 220 (Revised) | 21-33 | Track preparer/manager/partner stages consistently for every audit module. | Shared baseline tables `audit_module_records`, `audit_record_approvals` (`supabase/sql/audit_base_schema.sql`, RLS in `supabase/sql/audit_base_rls.sql`). | Central register rows showing module_code/status/stage plus approval decisions per stage. |
| ISA 600 (Revised) | 19-49 | Manage group components, instructions, and review oversight for component auditors. | GRP-1 schema/API (`supabase/sql/audit_GRP1_*`, `/api/group/*`), audit workspace (`apps/web/app/audit/group/page.tsx`). | ActivityLog (`GRP_*`), audit module manifests with workpaper links and review status. |
| ISA 402 | 9-21 | Evaluate service organisations, SOC reports, and complementary user controls. | SOC-1 schema/API (`supabase/sql/audit_SOC1_*`, `/api/soc/*`), service org workspace (`apps/web/app/audit/service-orgs/page.tsx`). | ActivityLog (`SOC_*`), module records documenting CUEC tests and exception escalations. |
| ISA 620 & ISA 610 | 9-21 / 15-24 | Document competence/objectivity assessments and reliance conclusions for specialists/internal audit. | EXP-1 schema/API (`supabase/sql/audit_EXP1_*`, `/api/exp/*`), specialists workspace (`apps/web/app/audit/specialists/page.tsx`). | Evidence manifests with memo documents, ActivityLog (`EXP_*`) entries; approval queue for conclusions. |
| ISA 720 (Revised) | 12-24 | Capture and resolve other information inconsistencies before report release. | OI-1 schema/API (`supabase/sql/audit_OI1_*`, `/api/oi/*`), other information workspace (`apps/web/app/audit/other-information/page.tsx`). | Other information manifest, flag history, ActivityLog (`OI_*`), manager approvals. |
| IESBA Code Section 600 | 600.5-600.22 | Guard independence when supplying tax/accounting support to audit clients. | Policy packs `T-GOV-1`, `A-GOV-1`; telemetry exception table (Phase 5). | ActivityLog severity flag; independence incidents in telemetry (Phase 5). |
| Malta ITA governance | CFR Circulars 05/2023-06/2023 | Require technical reviewer checkpoints on high-risk refund and ATAD matters. | Approval matrix row (T-GOV-1) auto-routes via approval_queue (`TAX_POLICY_APPROVAL`). | ActivityLog `MT_CIT_APPROVAL_SUBMITTED`, `MT_CIT_APPROVED` with policy pack `T-GOV-1`. |
| OECD Pillar Two & EU Minimum Tax Directive | Articles 6-10 | Model QDMTT and IIR calculations with GIR-ready evidence. | Pillar Two schema (`supabase/migrations/20250924200000_tax_pillar_two_schema.sql`), edge function branch `supabase/functions/tax-mt-nid`, UI `src/pages/tax/pillar-two.tsx`. | ActivityLog `PILLAR_TWO_COMPUTED`, `pillar_two_computations` history; GIR payload per computation. |
| OECD Model Tax Convention & MAP Manual | Articles 23, 25 | Maintain treaty relief determinations and MAP/APA dispute logs. | Treaty WHT schema (`supabase/migrations/20250924210000_tax_treaty_wht.sql`), calculator in `supabase/functions/tax-mt-nid`, UI `src/pages/tax/treaty-wht.tsx`. | ActivityLog `TREATY_WHT_COMPUTED`, dispute history in `tax_dispute_cases` & `tax_dispute_events`. |
| IRC §§951A, 163(j), 55, 4501 | Various | Compute US-specific overlays (GILTI, interest limitation, CAMT, stock buyback excise). | US overlay schema (`supabase/migrations/20250924213000_tax_us_overlays.sql`), calculators in `src/lib/tax/calculators.ts`, edge handler `supabase/functions/tax-mt-nid`, UI `src/pages/tax/us-overlays.tsx`. | ActivityLog `US_GILTI_COMPUTED`, `US_163J_COMPUTED`, `US_CAMT_COMPUTED`, `US_4501_COMPUTED`; history in `us_tax_overlay_calculations`. |
| ISQM 1 Monitoring | 48-52 | Capture SLA, coverage, and refusal telemetry for continuous quality management. | `telemetry_service_levels`, `telemetry_coverage_metrics`, `telemetry_refusal_events`; docs in `docs/telemetry.md`. | Dashboards join telemetry with ActivityLog; breaches flagged via `status`. |

## Financial Reporting & Close Controls
| Standard / Regulation | Clause reference | Control / Requirement | Implementation (code or schema) | Evidence captured |
| --- | --- | --- | --- | --- |
| IAS 1 | 15-25, 54-60 | Maintain complete ledger and chart of accounts aligned to presentation lines. | `ledger_accounts`, `coa_map`, draft FS endpoint (`apps/web/app/api/financials/draft/route.ts`). | Trial balance snapshots; FS mapping ActivityLog (`FS_MAPPING_APPLIED`). |
| IAS 1 | 134-138 | Document material variances vs prior/budget and obtain explanations. | `variance_rules`, `variance_results`, variance run API (`apps/web/app/api/variance/run/route.ts`). | ActivityLog (`VARIANCE_RUN`), variance result rows with status/explanations. |
| IAS 7 | 18-20, 43 | Capture cash balances and reconciling items before the cash flow statement. | `reconciliations` (type=BANK), reconciliation API (`apps/web/app/api/recon/*`), UI workbench (`apps/web/app/audit/reconciliations/page.tsx`). | Reconciliation schedules, ActivityLog (`RECON_CLOSED`), module manifest. |
| IAS 7 | 30-31 | Maintain working capital reconciliations (AR/AP/GRNI) feeding indirect cash flow. | Reconciliation schema + close lock validation in `apps/web/app/api/close/lock/route.ts`. | Closed reconciliations recorded with difference zero prior to lock. |
| IAS 21 | 9-23 | Identify FX balances and prepare remeasurement suggestions. | FX remeasure endpoint (`apps/web/app/api/fx/remeasure/route.ts`). | ActivityLog (`FX_REMEASURE_PREVIEW`). |
| IAS 8 / IAS 10 | 5, 41 | Capture audit trail for adjustments via controlled journal batches. | `journal_batches`, `ledger_entries`, journal API workflow. | ActivityLog (`JE_BATCH_CREATED`, `JE_SUBMITTED`, `JE_APPROVED`, `JE_POSTED`). |
| EU Accounting Directive 2013/34/EU | Art. 4-6 | Ensure reliable records and periodic closings. | Close lifecycle schema (`close_period`, `close_pbc_items`) and APIs. | ActivityLog (`CLOSE_ADVANCED`, `CLOSE_LOCKED`), approvals table entries. |
| EU Accounting Directive 2013/34/EU | Art. 36-40 | Management responsibility for internal control and documentation. | PBC template (`CHECKLISTS/ACCOUNTING/close_pbc_template.yaml`), ActivityLog, approvals. | PBC items with doc links and reviewer status. |
| Malta GAPSME | Regs. 18-27 | SME close discipline matching IFRS-based controls. | Same close workflow; FS basis stored on `fs_lines`. | Evidence identical to IFRS path; basis flag on `fs_lines`/`coa_map`. |
| ISA 330 (audit evidence) | 18-24 | Provide auditors with evidence for controls over financial reporting. | ActivityLog + document management; ATT manifest utility (`apps/web/lib/audit/evidence.ts`). | Exported schedules, TB snapshots, evidence manifest JSON. |
| ISA 500 | 6-9 | Maintain complete audit trail for balances and transactions. | TB snapshot table; journaling controls; recon exports. | Snapshot records with totals; ledger entries cross-reference. |
| Internal policy | Close governance policy | Documented responsibilities, controls and approvals. | `/STANDARDS/POLICY/close_governance.md`; approvals enforcement in APIs. | Policy acknowledgement + approvals in `approvals`. |
| ISA 300 | 7-12 | Capture and version overall audit strategy before fieldwork. | `public.audit_plans` (`supabase/migrations/20250924095000_audit_plan_strategy_materiality.sql`), strategy upsert API, UI planner. | ActivityLog `PLAN_CREATED`/`PLAN_STRATEGY_UPDATED`; change log. |
| ISA 320 | 10-14 | Determine materiality thresholds with rationale. | `public.materiality_sets`, materiality endpoint, planning workspace form. | ActivityLog `MATERIALITY_SET`; memo export. |
| ISA 220 (Revised) | 24-30 | Partner (and EQR where applicable) approval before releasing the audit plan. | Approval queue (`AUDIT_PLAN_FREEZE`), handler in `supabase/functions/audit-plan/index.ts`. | ActivityLog `PLAN_SUBMITTED`, `PLAN_APPROVED`, `PLAN_LOCKED`. |
| ISA 230 | 8-11 | Preserve tax return schedules and supporting documentation. | `return_files` table; prepare-return endpoint; UI preview. | Return file JSON snapshot + doc id; ActivityLog `MT_CIT_RETURN_READY`. |

## Risk, Controls, Analytics
| Standard / Regulation | Clause reference | Control / Requirement | Implementation (code or schema) | Evidence captured |
| --- | --- | --- | --- | --- |
| ISA 315 (Revised) | 19-32 | Document identified risks with categorisation, assertions, analytics linkage. | `public.audit_risks`, `public.audit_risk_signals`, `public.audit_risk_activity` (`supabase/migrations/20250924120000_audit_risk_register.sql`); types in `supabase/src/integrations/supabase/types.ts`. | ActivityLog with policy pack `AP-GOV-1`; risk activity + analytics snapshots. |
| ISA 315 (Revised) | 12-23, 26-29 | Maintain controls register tied to engagements. | `public.controls` schema (`supabase/sql/audit_CTRL1_schema.sql`), APIs `apps/web/app/api/controls/*`. | ActivityLog (`CTRL_ADDED`, `CTRL_UPDATED`), control rows with timestamps. |
| ISA 330 | 18-26 | Walkthroughs & attribute testing with sample sizes ≥25. | Tables `control_walkthroughs`, `control_tests`; Sampling C1; `/api/controls/test/run`; UI `apps/web/app/audit/controls/page.tsx`. | Stored walkthrough/test results; sampling plans; ActivityLog `CTRL_TEST_RUN`. |
| ISA 330 | 7-29 | Link risks to responses, analytics, and substantive procedures. | `public.audit_responses`, `public.audit_response_checks` (`supabase/migrations/20250924124000_audit_responses_matrix.sql`), edge function `audit-responses`, UI planner (TBD). | ActivityLog `RESPONSE_*`; completeness checks. |
| ISA 240 | 15-32, 47 | Fraud brainstorming, inherent fraud risks, responses, and JE strategy. | `public.fraud_plans`, `public.fraud_plan_actions`, `public.journal_entry_strategies` (`supabase/migrations/20250924130000_fraud_plan_je_strategy.sql`). | ActivityLog (`FRAUD_PLAN_*`), fraud approvals, JE filters. |
| ISA 265 | 7-11 | Deficiencies with severity and recommendation to TCWG packs. | `public.deficiencies`; auto-creation in `/api/controls/test/run/route.ts`; manual endpoint. | ActivityLog (`CTRL_DEFICIENCY_RAISED`), deficiency statuses. |
| ITGC coverage | ISA 315.A128, ISA 330.A44 | Track access/change/operations ITGC groups. | `public.itgc_groups` schema; include in controls API; UI ITGC panel. | ITGC rows linked to engagement with scope/notes. |
| Firm policy | Audit controls governance | Methodology for register, walkthroughs, testing, deficiencies. | `/STANDARDS/POLICY/audit_controls_itgc.md`. | Policy references and alignments. |
| ISA 500 / ISA 520 | 6-12, 5-7 | Deterministic analytics with lineage/parameters/exceptions. | `public.ada_runs`, `public.ada_exceptions`; engine `apps/web/lib/audit/analytics-engine.ts`; APIs `apps/web/app/api/ada/*`. | ActivityLog (`ADA_RUN_STARTED`, `ADA_RUN_COMPLETED`, `ADA_EXCEPTION_ADDED`); dataset hash & parameters. |

> Evidence references assume archive hooks (A-1 scope) capture document ids and ActivityLog entries upon completion.
