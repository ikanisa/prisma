name: Desktop App - Build, Sign & Release

on:
  push:
    branches: [main, refactor/consolidate-tauri]
    paths:
      - 'src-tauri/**'
      - 'src/**'
      - 'apps/web/**'
      - '.github/workflows/desktop-app-release.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src-tauri/**'
      - 'src/**'
      - 'apps/web/**'
  workflow_dispatch:
    inputs:
      target:
        description: 'Build target (macos/windows/linux/all)'
        required: false
        default: 'all'
      skip_signing:
        description: 'Skip code signing (true/false)'
        required: false
        default: 'false'

env:
  TAURI_PRIVATE_KEY: ${{ secrets.TAURI_PRIVATE_KEY }}
  TAURI_KEY_PASSWORD: ${{ secrets.TAURI_KEY_PASSWORD }}

jobs:
  build-macos:
    name: macOS Universal (Intel + Apple Silicon)
    runs-on: macos-latest
    if: |
      github.event.inputs.target == 'macos' || 
      github.event.inputs.target == 'all' || 
      github.event.inputs.target == ''
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install Rust universal target
        run: |
          rustup target add aarch64-apple-darwin
          rustup target add x86_64-apple-darwin

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Import code signing certificate
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') &&
          (github.event.inputs.skip_signing != 'true') &&
          (secrets.APPLE_CERTIFICATE != '')
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Decode certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12

          # Create keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -lut 21600 build.keychain

          # Import certificate
          security import certificate.p12 \
            -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/security

          # Enable codesigning from non-interactive shell
          security set-key-partition-list \
            -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" \
            build.keychain

          # Verify certificate
          security find-identity -v build.keychain

          echo "âœ… Certificate imported successfully"

      - name: Build Tauri app (Universal Binary)
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          ENABLE_CODE_SIGNING: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' && github.event.inputs.skip_signing != 'true' }}
        run: |
          # Build for both architectures
          if [ "$ENABLE_CODE_SIGNING" = "true" ]; then
            echo "ðŸ” Building with code signing..."
            pnpm tauri build --target universal-apple-darwin
          else
            echo "âš ï¸  Building without code signing..."
            pnpm tauri build --target universal-apple-darwin --config '{"bundle":{"macOS":{"signingIdentity":null}}}'
          fi

      - name: Notarize app
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') &&
          (github.event.inputs.skip_signing != 'true') &&
          (secrets.APPLE_ID != '')
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Find the app bundle
          APP_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app" | head -n 1)
          DMG_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" | head -n 1)

          if [ -n "$APP_PATH" ]; then
            echo "ðŸ“¦ Notarizing app bundle: $APP_PATH"
            
            # Create ZIP for notarization
            ditto -c -k --keepParent "$APP_PATH" "app.zip"
            
            # Submit for notarization
            xcrun notarytool submit app.zip \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
            
            # Staple the notarization ticket
            xcrun stapler staple "$APP_PATH"
            
            echo "âœ… App notarized and stapled"
          fi

          if [ -n "$DMG_PATH" ]; then
            echo "ðŸ“¦ Notarizing DMG: $DMG_PATH"
            
            # Submit DMG for notarization
            xcrun notarytool submit "$DMG_PATH" \
              --apple-id "$APPLE_ID" \
              --password "$APPLE_PASSWORD" \
              --team-id "$APPLE_TEAM_ID" \
              --wait
            
            # Staple the notarization ticket
            xcrun stapler staple "$DMG_PATH"
            
            echo "âœ… DMG notarized and stapled"
          fi

      - name: Generate checksums
        run: |
          cd src-tauri/target/universal-apple-darwin/release/bundle
          
          # DMG checksums
          if [ -d "dmg" ]; then
            cd dmg
            for file in *.dmg; do
              if [ -f "$file" ]; then
                shasum -a 256 "$file" > "$file.sha256"
              fi
            done
            cd ..
          fi
          
          # App bundle checksums
          if [ -d "macos" ]; then
            cd macos
            for app in *.app; do
              if [ -d "$app" ]; then
                ditto -c -k --keepParent "$app" "$app.zip"
                shasum -a 256 "$app.zip" > "$app.zip.sha256"
              fi
            done
          fi

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: Prisma-Glow-macOS-Universal-DMG
          path: |
            src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.dmg
            src-tauri/target/universal-apple-darwin/release/bundle/dmg/*.sha256
          retention-days: 30

      - name: Upload App Bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: Prisma-Glow-macOS-Universal-App
          path: |
            src-tauri/target/universal-apple-darwin/release/bundle/macos/*.zip
            src-tauri/target/universal-apple-darwin/release/bundle/macos/*.sha256
          retention-days: 30

      - name: Cleanup
        if: always()
        run: |
          rm -f certificate.p12 app.zip
          security delete-keychain build.keychain 2>/dev/null || true

      - name: Build summary
        run: |
          echo "### ðŸŽ‰ macOS Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # App info
          APP_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app" | head -n 1)
          if [ -n "$APP_PATH" ]; then
            APP_SIZE=$(du -sh "$APP_PATH" | cut -f1)
            echo "**App Bundle:** $APP_SIZE" >> $GITHUB_STEP_SUMMARY
          fi
          
          # DMG info
          DMG_PATH=$(find src-tauri/target/universal-apple-darwin/release/bundle/dmg -name "*.dmg" | head -n 1)
          if [ -n "$DMG_PATH" ]; then
            DMG_SIZE=$(du -sh "$DMG_PATH" | cut -f1)
            echo "**DMG:** $DMG_SIZE" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Signing status
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            if [ -n "${{ secrets.APPLE_CERTIFICATE }}" ]; then
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âœ… **Signed and notarized**" >> $GITHUB_STEP_SUMMARY
            else
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "âš ï¸  **Not signed** (certificates not configured)" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â„¹ï¸  **Development build** (not signed)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Targets:** Intel (x86_64) + Apple Silicon (aarch64)" >> $GITHUB_STEP_SUMMARY

  build-windows:
    name: Windows (x64)
    runs-on: windows-latest
    if: |
      github.event.inputs.target == 'windows' || 
      github.event.inputs.target == 'all' || 
      github.event.inputs.target == ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app
        run: pnpm tauri build

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        with:
          name: Prisma-Glow-Windows-x64
          path: |
            src-tauri/target/release/bundle/msi/*.msi
            src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 30

  build-linux:
    name: Linux (x64)
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.target == 'linux' || 
      github.event.inputs.target == 'all' || 
      github.event.inputs.target == ''

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.0-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Tauri app
        run: pnpm tauri build

      - name: Upload DEB/AppImage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Prisma-Glow-Linux-x64
          path: |
            src-tauri/target/release/bundle/deb/*.deb
            src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 30

  release:
    name: Create GitHub Release
    needs: [build-macos, build-windows, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure
        run: ls -R artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          name: Desktop App v${{ github.run_number }}
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.zip
            artifacts/**/*.msi
            artifacts/**/*.exe
            artifacts/**/*.deb
            artifacts/**/*.AppImage
            artifacts/**/*.sha256
          body: |
            ## Prisma Glow Desktop App v${{ github.run_number }}
            
            ### Downloads
            
            **macOS** (Universal - Intel + Apple Silicon)
            - DMG Installer (Recommended)
            - App Bundle (ZIP)
            
            **Windows** (x64)
            - MSI Installer (Recommended)
            - NSIS Installer
            
            **Linux** (x64)
            - DEB Package (Debian/Ubuntu)
            - AppImage (Universal)
            
            ### What's New
            - Full offline sync support
            - Improved performance
            - Bug fixes and stability improvements
            
            ### Checksums
            SHA256 checksums included for all artifacts.
