name: Build and Sign Desktop Apps

on:
  push:
    branches: [main]
    paths:
      - 'desktop-app/**'
      - 'scripts/build-desktop-apps.sh'
      - 'scripts/sign_*.sh'
      - '.github/workflows/desktop-build-sign.yml'
  pull_request:
    branches: [main]
    paths:
      - 'desktop-app/**'
      - 'scripts/build-desktop-apps.sh'
      - 'scripts/sign_*.sh'
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode (release or debug)'
        required: false
        default: 'release'

jobs:
  build-macos:
    name: Build macOS Desktop Apps
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      
      - name: Install Xcode Command Line Tools
        run: |
          xcode-select --install 2>/dev/null || true
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            desktop-app/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      
      - name: Install dependencies
        run: |
          cd desktop-app
          pnpm install --frozen-lockfile
      
      - name: Build desktop apps
        env:
          BUILD_MODE: ${{ github.event.inputs.build_mode || 'release' }}
        run: |
          chmod +x scripts/build-desktop-apps.sh
          ./scripts/build-desktop-apps.sh
      
      - name: Import code signing certificate
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          MACOS_CERT_BASE64: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          if [ -n "$MACOS_CERT_BASE64" ]; then
            echo "$MACOS_CERT_BASE64" | base64 --decode > cert.p12
            
            # Create temporary keychain
            security create-keychain -p temp-password build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p temp-password build.keychain
            security set-keychain-settings -t 3600 -u build.keychain
            
            # Import certificate
            security import cert.p12 -k build.keychain -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
            
            # Allow codesign to access keychain
            security set-key-partition-list -S apple-tool:,apple: -s -k temp-password build.keychain
            
            echo "âœ“ Certificate imported successfully"
          else
            echo "âš  No certificate configured, skipping code signing"
          fi
      
      - name: Sign desktop apps
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          SIGNING_IDENTITY: ${{ secrets.MACOS_CERT_IDENTITY || 'Inhouse Dev Signing' }}
        run: |
          if [ -n "${{ secrets.MACOS_CERT_P12 }}" ]; then
            chmod +x scripts/sign_all_apps.sh
            ./scripts/sign_all_apps.sh
          else
            echo "âš  Skipping code signing (no certificate configured)"
          fi
      
      - name: Create distribution archives
        run: |
          cd dist/mac
          ditto -c -k --keepParent AdminPanel.app AdminPanel.app.zip
          ditto -c -k --keepParent ClientPortal.app ClientPortal.app.zip
          
          # Generate checksums
          shasum -a 256 AdminPanel.app.zip > AdminPanel.app.zip.sha256
          shasum -a 256 ClientPortal.app.zip > ClientPortal.app.zip.sha256
      
      - name: Upload Admin Panel app
        uses: actions/upload-artifact@v4
        with:
          name: AdminPanel-macOS
          path: |
            dist/mac/AdminPanel.app.zip
            dist/mac/AdminPanel.app.zip.sha256
          retention-days: 30
      
      - name: Upload Client Portal app
        uses: actions/upload-artifact@v4
        with:
          name: ClientPortal-macOS
          path: |
            dist/mac/ClientPortal.app.zip
            dist/mac/ClientPortal.app.zip.sha256
          retention-days: 30
      
      - name: Cleanup keychain
        if: always()
        run: |
          if [ -f cert.p12 ]; then
            rm cert.p12
          fi
          security delete-keychain build.keychain 2>/dev/null || true
      
      - name: Build summary
        run: |
          echo "### ðŸŽ‰ Desktop Apps Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Admin Panel**" >> $GITHUB_STEP_SUMMARY
          echo "- Path: \`dist/mac/AdminPanel.app\`" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(du -sh dist/mac/AdminPanel.app | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Client Portal**" >> $GITHUB_STEP_SUMMARY
          echo "- Path: \`dist/mac/ClientPortal.app\`" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(du -sh dist/mac/ClientPortal.app | cut -f1)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.MACOS_CERT_P12 }}" ]; then
            echo "**Code Signing**: âœ… Signed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Code Signing**: âš ï¸ Not configured" >> $GITHUB_STEP_SUMMARY
          fi

  build-windows:
    name: Build Windows Desktop Apps
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Install dependencies
        run: |
          cd desktop-app
          pnpm install --frozen-lockfile
      
      - name: Build Admin Panel
        run: |
          cd desktop-app
          pnpm run build
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Desktop-Windows
          path: |
            desktop-app/src-tauri/target/release/bundle/msi/*.msi
            desktop-app/src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 30

  build-linux:
    name: Build Linux Desktop Apps
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
      
      - name: Install dependencies
        run: |
          cd desktop-app
          pnpm install --frozen-lockfile
      
      - name: Build Admin Panel
        run: |
          cd desktop-app
          pnpm run build
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Desktop-Linux
          path: |
            desktop-app/src-tauri/target/release/bundle/deb/*.deb
            desktop-app/src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 30
