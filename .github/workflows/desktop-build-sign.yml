name: Build and Sign Desktop Apps

on:
  push:
    branches: [main]
    paths:
      - 'desktop-app/**'
      - 'src/**'
      - 'src-tauri/**'
      - 'scripts/build-desktop-apps.sh'
      - 'scripts/sign_*.sh'
      - '.github/workflows/desktop-build-sign.yml'
      - 'package.json'
      - 'vite.config.ts'
  pull_request:
    branches: [main]
    paths:
      - 'desktop-app/**'
      - 'src/**'
      - 'src-tauri/**'
      - 'scripts/build-desktop-apps.sh'
      - 'scripts/sign_*.sh'
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode (release or debug)'
        required: false
        default: 'release'

jobs:
  build-macos:
    name: Build macOS Desktop App
    runs-on: macos-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: aarch64-apple-darwin,x86_64-apple-darwin
      
      - name: Install Xcode Command Line Tools
        run: |
          xcode-select --install 2>/dev/null || true
          sudo xcode-select --switch /Applications/Xcode.app/Contents/Developer
      
      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            desktop-app/src-tauri/target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Cache pnpm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-
      
      - name: Install root dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install desktop-app dependencies
        run: |
          cd desktop-app
          pnpm install --frozen-lockfile
      
      - name: Build frontend
        run: pnpm run build
      
      - name: Build Tauri app
        env:
          BUILD_MODE: ${{ github.event.inputs.build_mode || 'release' }}
        run: |
          cd desktop-app
          if [ "$BUILD_MODE" = "debug" ]; then
            pnpm run build:debug
          else
            pnpm run build
          fi
      
      - name: Import code signing certificate
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          MACOS_CERT_BASE64: ${{ secrets.MACOS_CERT_P12 }}
          MACOS_CERT_PASSWORD: ${{ secrets.MACOS_CERT_PASSWORD }}
        run: |
          if [ -n "$MACOS_CERT_BASE64" ]; then
            echo "$MACOS_CERT_BASE64" | base64 --decode > cert.p12
            
            # Create temporary keychain
            security create-keychain -p temp-password build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p temp-password build.keychain
            security set-keychain-settings -t 3600 -u build.keychain
            
            # Import certificate
            security import cert.p12 -k build.keychain -P "$MACOS_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
            
            # Allow codesign to access keychain
            security set-key-partition-list -S apple-tool:,apple: -s -k temp-password build.keychain
            
            echo "âœ“ Certificate imported successfully"
          else
            echo "âš  No certificate configured, skipping code signing"
          fi
      
      - name: Sign desktop app
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        env:
          SIGNING_IDENTITY: ${{ secrets.MACOS_CERT_IDENTITY || 'Inhouse Dev Signing' }}
        run: |
          if [ -n "${{ secrets.MACOS_CERT_P12 }}" ]; then
            APP_PATH=$(find desktop-app/src-tauri/target/release/bundle -name "*.app" | head -1)
            if [ -n "$APP_PATH" ]; then
              # Sign nested components first, then the main bundle
              # This ensures proper signature chain for notarization
              find "$APP_PATH/Contents/MacOS" -type f -perm +111 -exec codesign --force --options runtime --sign "$SIGNING_IDENTITY" {} \; 2>/dev/null || true
              find "$APP_PATH/Contents/Frameworks" -name "*.dylib" -exec codesign --force --options runtime --sign "$SIGNING_IDENTITY" {} \; 2>/dev/null || true
              find "$APP_PATH/Contents/Frameworks" -name "*.framework" -exec codesign --force --options runtime --sign "$SIGNING_IDENTITY" {} \; 2>/dev/null || true
              
              # Sign the main app bundle
              codesign --force --options runtime --sign "$SIGNING_IDENTITY" "$APP_PATH"
              
              # Verify the signature
              codesign --verify --deep --strict "$APP_PATH"
              echo "âœ“ App signed and verified: $APP_PATH"
            fi
          else
            echo "âš  Skipping code signing (no certificate configured)"
          fi
      
      # Notarization placeholder - requires Apple Developer account
      - name: Notarize app (placeholder)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && false
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          # Placeholder for notarization
          # xcrun notarytool submit <path-to-dmg> --apple-id "$APPLE_ID" --team-id "$APPLE_TEAM_ID" --password "$APPLE_APP_SPECIFIC_PASSWORD" --wait
          # xcrun stapler staple <path-to-app>
          echo "Notarization requires Apple Developer account setup"
      
      - name: Create distribution archive
        run: |
          mkdir -p dist/mac
          APP_PATH=$(find desktop-app/src-tauri/target/release/bundle -name "*.app" | head -1)
          if [ -n "$APP_PATH" ]; then
            APP_NAME=$(basename "$APP_PATH")
            ditto -c -k --keepParent "$APP_PATH" "dist/mac/${APP_NAME%.app}.app.zip"
            shasum -a 256 "dist/mac/${APP_NAME%.app}.app.zip" > "dist/mac/${APP_NAME%.app}.app.zip.sha256"
          fi
      
      - name: Upload macOS app
        uses: actions/upload-artifact@v4
        with:
          name: PrismaGlow-macOS
          path: |
            dist/mac/*.zip
            dist/mac/*.sha256
          retention-days: 30
          if-no-files-found: warn
      
      - name: Cleanup keychain
        if: always()
        run: |
          if [ -f cert.p12 ]; then
            rm cert.p12
          fi
          security delete-keychain build.keychain 2>/dev/null || true
      
      - name: Build summary
        run: |
          echo "### ðŸŽ‰ Desktop App Built Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          APP_PATH=$(find desktop-app/src-tauri/target/release/bundle -name "*.app" 2>/dev/null | head -1)
          if [ -n "$APP_PATH" ]; then
            echo "**Prisma Glow Desktop**" >> $GITHUB_STEP_SUMMARY
            echo "- Path: \`$APP_PATH\`" >> $GITHUB_STEP_SUMMARY
            echo "- Size: $(du -sh "$APP_PATH" | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.MACOS_CERT_P12 }}" ]; then
            echo "**Code Signing**: âœ… Signed" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Code Signing**: âš ï¸ Not configured" >> $GITHUB_STEP_SUMMARY
          fi

  build-windows:
    name: Build Windows Desktop App
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Install root dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install desktop-app dependencies
        run: |
          cd desktop-app
          pnpm install --frozen-lockfile
      
      - name: Build frontend
        run: pnpm run build
      
      - name: Build Tauri app
        run: |
          cd desktop-app
          pnpm run build
      
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PrismaGlow-Windows
          path: |
            desktop-app/src-tauri/target/release/bundle/msi/*.msi
            desktop-app/src-tauri/target/release/bundle/nsis/*.exe
          retention-days: 30
          if-no-files-found: warn

  build-linux:
    name: Build Linux Desktop App
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.12.0'
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.12.3
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf
      
      - name: Install root dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Install desktop-app dependencies
        run: |
          cd desktop-app
          pnpm install --frozen-lockfile
      
      - name: Build frontend
        run: pnpm run build
      
      - name: Build Tauri app
        run: |
          cd desktop-app
          pnpm run build
      
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PrismaGlow-Linux
          path: |
            desktop-app/src-tauri/target/release/bundle/deb/*.deb
            desktop-app/src-tauri/target/release/bundle/appimage/*.AppImage
          retention-days: 30
          if-no-files-found: warn
