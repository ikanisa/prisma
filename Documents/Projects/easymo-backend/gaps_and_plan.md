# Gaps & Implementation Plan

| ID | Priority | Issue | Impact | Fix Approach | Owner | ETA | Test Plan | Rollback |
| --- | --- | --- | --- | --- | --- | --- | --- | --- |
| GAP-01 | P1 | Remaining flows still emit legacy `console` logs (baskets, QR, schedule, leaderboard) | Inconsistent logging prevents alerting/forensics on key journeys; hampers observability SLAs | Replace `console.*` with structured logger helpers across outstanding modules, funding masking where needed | Webhook Platform | 1 sprint | Run lint/format, trigger representative flows in staging and confirm JSON logs arrive in Logflare/Sentry; regression on user interactions | Revert module changes to prior commit; logger defaults still work |
| GAP-02 | P1 | `wa_events`, `served_drivers`, `served_passengers` tables grow unbounded | Table bloat risks degraded write latency and higher storage cost | Add scheduled Supabase cron job (or SQL function) to prune rows older than 30 days; add partial indexes if required | Data Infra | 2 sprints | Execute job in staging, verify retention and that new rows persist; monitor Supabase dashboard for size plateau | Disable cron + restore recent backup snapshot if job misbehaves |
| GAP-03 | P2 | Lack of alerting when idempotency or signature verification fails | Silent failures could indicate abuse or outages without paging on-call | Emit metrics/structured events to monitoring (Logflare alert rules or Supabase functions) and wire to PagerDuty/Sentry | SRE | 1 sprint | Simulate signature failure and idempotency conflict in staging; confirm alert triggers and clears | Disable alert rule or revert configuration; code path already safe |
| GAP-04 | P2 | No shared request/correlation ID propagated beyond webhook entry | Difficult to follow multi-step flows across services/logs | Extend `ConversationContext` to carry `requestId` and include in downstream logging + RPC payloads | Webhook Platform | 2 sprints | Integration test in staging verifying logs for referral, wallet, OCR all include same `requestId` | Feature flag new context field; roll back by dropping the property |
| GAP-05 | P3 | Automated verification of structured logging absent | Risk of regressions reintroducing raw consoles/PII logging | Add lint/test rule (e.g. ESLint custom rule or unit tests) and snapshot tests covering key flows | QA Automation | 3 sprints | Run new test suite in CI; intentionally add `console.log` to confirm failure | Remove lint rule/test config; fall back to manual reviews |
| GAP-06 | P3 | Production env hardening for signature secret not yet audited | Misconfigured env could still set `WA_ALLOW_MISSING_SECRET=true` inadvertently | Audit environment variables, update deployment docs, add CI check preventing that flag in prod/stg | DevOps | 2 weeks | Run CI check verifying env manifests; confirm production config omits the flag and `WA_APP_SECRET` present | Remove CI check if blocking; revert doc change |
