# Multi-Provider AI Agent System - Usage Guide

## Quick Start

### Python Usage

```python
from server.agents.base import AgentOrchestrator, AgentProvider, AgentToolDefinition
from server.agents.openai_provider import OpenAIAgentProvider
from server.agents.gemini_provider import GeminiAgentProvider
from server.integrations.google_maps import GoogleMapsService

# Initialize orchestrator
orchestrator = AgentOrchestrator()
orchestrator.register_provider(AgentProvider.OPENAI, OpenAIAgentProvider())
orchestrator.register_provider(AgentProvider.GEMINI, GeminiAgentProvider())

# Create an agent with tools
maps_service = GoogleMapsService()
tools = [
    AgentToolDefinition(
        name="search_places",
        description="Search for places near a location",
        parameters={
            "type": "object",
            "properties": {
                "query": {"type": "string"},
                "location": {"type": "object"}
            }
        },
        handler=maps_service.search_places
    )
]

# Create agent with OpenAI
agent_id = await orchestrator.providers[AgentProvider.OPENAI].create_agent(
    name="Location Assistant",
    instructions="You are a helpful assistant that helps users find places.",
    tools=tools,
    model="gpt-4o"
)

# Execute with automatic fallback
response = await orchestrator.execute(
    agent_id=agent_id,
    input_text="Find coffee shops near Times Square",
    provider=AgentProvider.OPENAI,
    fallback_providers=[AgentProvider.GEMINI]
)

print(response.content)
print(f"Used {response.usage['total_tokens']} tokens")
```

### TypeScript Usage

```typescript
import { createAgentGateway, AgentProvider } from './services/rag/agents/unified-gateway.js';

// Create gateway with fallback
const gateway = createAgentGateway({
  defaultProvider: AgentProvider.OPENAI,
  fallbackProviders: [AgentProvider.GEMINI]
});

// Create an agent
const agentId = await gateway.createAgent({
  name: 'Tax Assistant',
  instructions: 'You are an expert tax advisor.',
  model: 'gpt-4o',
  tools: [],
  provider: AgentProvider.OPENAI
});

// Execute agent
const response = await gateway.execute({
  agentId,
  input: 'What are the tax implications of remote work?',
  context: { jurisdiction: 'US' }
});

console.log(response.content);

// Stream responses
for await (const event of gateway.stream({ agentId, input: 'Explain VAT' })) {
  if (event.type === 'content_delta') {
    process.stdout.write(event.data.content);
  }
}
```

## Google Search Grounding

```python
from server.agents.gemini_provider import GeminiAgentProvider

gemini = GeminiAgentProvider()

agent_id = await gemini.create_agent(
    name="Research Assistant",
    instructions="You are a research assistant with access to current information.",
    tools=[],
    model="gemini-2.0-flash-exp"
)

# Execute with grounding
response = await gemini.run_with_grounding(
    agent_id=agent_id,
    input_text="What are the latest developments in AI regulation?",
    enable_search=True
)

# Check grounding metadata
if response.metadata.get('grounded'):
    print("Sources:")
    for chunk in response.metadata['grounding_metadata']['grounding_chunks']:
        print(f"- {chunk['web']['title']}: {chunk['web']['uri']}")
```

## Image Generation

```python
from server.integrations.image_generation import ImageGenerationService, ImageProvider

image_service = ImageGenerationService()

# Generate with Imagen (with DALL-E fallback)
images = await image_service.generate(
    prompt="A modern office with AI assistants helping accountants",
    preferred_provider=ImageProvider.IMAGEN,
    num_images=2,
    aspect_ratio="16:9"
)

for img in images:
    print(f"Generated by {img.provider.value}: {img.url}")
```

## Google Maps Integration

```python
from server.integrations.google_maps import GoogleMapsService

maps = GoogleMapsService()

# Search places
places = await maps.search_places(
    query="tax offices",
    location={"lat": 40.7128, "lng": -74.0060},
    radius=5000
)

for place in places:
    print(f"{place.name} - {place.address}")
    print(f"Rating: {place.rating}")

# Get directions
directions = await maps.get_directions(
    origin="Times Square, New York",
    destination="Central Park, New York",
    mode="walking"
)

print(f"Distance: {directions.distance}")
print(f"Duration: {directions.duration}")
```

## Environment Variables

```bash
# Required
GOOGLE_API_KEY=your_google_api_key
OPENAI_API_KEY=your_openai_api_key

# Optional (defaults to GOOGLE_API_KEY)
GOOGLE_MAPS_API_KEY=your_maps_api_key

# Python service URL for TypeScript gateway
PYTHON_AGENT_SERVICE_URL=http://localhost:8000

# Feature flags
GEMINI_LIVE_ENABLED=true
IMAGEN_ENABLED=true
AGENT_FALLBACK_ENABLED=true
```

## API Endpoints

### Create Agent
```bash
POST /agents/v2/create
{
  "name": "Tax Assistant",
  "instructions": "You are a tax expert",
  "model": "gpt-4o",
  "tools": [],
  "provider": "openai"
}
```

### Execute Agent
```bash
POST /agents/v2/execute
{
  "agent_id": "agent_1",
  "input_text": "What is VAT?",
  "context": {"jurisdiction": "EU"},
  "provider": "openai"
}
```

### Stream Agent
```bash
POST /agents/v2/stream
{
  "agent_id": "agent_1",
  "input_text": "Explain corporate tax",
  "provider": "gemini"
}
```

## Best Practices

1. **Provider Selection**
   - Use OpenAI for complex reasoning and tool orchestration
   - Use Gemini for fast responses and grounded search
   - Always configure fallback providers

2. **Tool Handlers**
   - Keep tool functions async
   - Handle errors gracefully
   - Return structured data

3. **Streaming**
   - Use streaming for long responses
   - Implement proper error handling
   - Send heartbeats for long-running operations

4. **Cost Optimization**
   - Use Gemini Flash for simple queries
   - Cache frequently used responses
   - Monitor token usage
